<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UMate AI - ìˆœìˆ˜ ì±—ë´‡ í…ŒìŠ¤íŠ¸</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 800px;
        height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        padding: 25px;
        text-align: center;
        position: relative;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 8px;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        font-size: 16px;
      }

      .pure-badge {
        position: absolute;
        top: 12px;
        left: 20px;
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 11px;
        font-weight: bold;
      }

      .status {
        position: absolute;
        top: 18px;
        right: 20px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status.connected {
        background: rgba(34, 197, 94, 0.25);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #16a34a;
      }

      .status.disconnected {
        background: rgba(239, 68, 68, 0.25);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #dc2626;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        background: #f8fafc;
      }

      .welcome-section {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .welcome-section h3 {
        margin-bottom: 10px;
        font-size: 18px;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .feature-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: transform 0.2s;
      }

      .feature-card:hover {
        transform: translateY(-2px);
      }

      .feature-card h4 {
        color: #4f46e5;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .feature-card p {
        color: #6b7280;
        font-size: 12px;
      }

      .quick-examples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .example-btn {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .example-btn:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
      }

      .message {
        margin-bottom: 20px;
        display: flex;
        animation: slideIn 0.4s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 75%;
        padding: 15px 20px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.6;
        position: relative;
      }

      .user .message-content {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
      }

      .bot .message-content {
        background: white;
        color: #374151;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .system .message-content {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
        font-size: 13px;
        max-width: 90%;
        margin: 0 auto;
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        max-width: 75%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: flex;
        gap: 6px;
        margin-right: 10px;
      }

      .typing-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #9ca3af;
        animation: typing 1.6s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .control-btn:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
      }

      .control-btn.active {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
      }

      .input-container {
        padding: 25px;
        background: white;
        border-top: 1px solid #e5e7eb;
      }

      .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      #messageInput {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 25px;
        font-size: 15px;
        resize: none;
        min-height: 50px;
        max-height: 120px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.3s;
      }

      #messageInput:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .send-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 18px;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      }

      .send-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
      }

      .send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }

      .voice-btn {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .voice-btn.recording {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }

      .connection-info {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #0369a1;
      }

      @media (max-width: 768px) {
        .container {
          height: 100vh;
          border-radius: 0;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 24px;
        }

        .message-content {
          max-width: 85%;
        }

        .features {
          grid-template-columns: 1fr;
        }

        .quick-examples {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="pure-badge">PURE CHATBOT</div>
        <h1>ğŸ¤– UMate AI Assistant</h1>
        <p>ìˆœìˆ˜ ì±—ë´‡ ëª¨ë“œ - OpenAI API ì§ì ‘ ì—°ê²°</p>
        <div class="status disconnected" id="status">ì—°ê²° ì¤‘...</div>
      </div>

      <div class="chat-container">
        <div class="messages" id="messages">
          <div class="welcome-section">
            <h3>ğŸš€ ìˆœìˆ˜ ì±—ë´‡ ëª¨ë“œ</h3>
            <p>ë°ì´í„°ë² ì´ìŠ¤ ì—†ì´ OpenAI GPT-4o miniì™€ ì§ì ‘ ëŒ€í™”í•˜ì„¸ìš”!</p>
          </div>

          <div class="features">
            <div class="feature-card">
              <h4>âš¡ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°</h4>
              <p>íƒ€ì´í•‘í•˜ë“¯ ë‹µë³€ ìƒì„±</p>
            </div>
            <div class="feature-card">
              <h4>ğŸ¤ ìŒì„± ì§€ì›</h4>
              <p>ë§í•˜ê¸° & ë“£ê¸° ê°€ëŠ¥</p>
            </div>
            <div class="feature-card">
              <h4>ğŸ§  GPT-4o mini</h4>
              <p>ìµœì‹  AI ëª¨ë¸ ì‚¬ìš©</p>
            </div>
            <div class="feature-card">
              <h4>ğŸ’¬ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”</h4>
              <p>í•œêµ­ì–´ ì™„ë²½ ì§€ì›</p>
            </div>
          </div>

          <div class="connection-info" id="connectionInfo">
            ğŸ“¡ WebSocket ì—°ê²° ëŒ€ê¸° ì¤‘... í¬íŠ¸ 3000ì—ì„œ chatbot.jsê°€ ì‹¤í–‰ ì¤‘ì¸ì§€
            í™•ì¸í•´ì£¼ì„¸ìš”.
          </div>

          <div class="quick-examples">
            <div
              class="example-btn"
              onclick="sendExample('ì•ˆë…•í•˜ì„¸ìš”! ìê¸°ì†Œê°œ í•´ì£¼ì„¸ìš”')"
            >
              ğŸ‘‹ ì¸ì‚¬ & ì†Œê°œ
            </div>
            <div
              class="example-btn"
              onclick="sendExample('ì˜¤ëŠ˜ ë‚ ì”¨ê°€ ì–´ë–¤ê°€ìš”?')"
            >
              ğŸŒ¤ï¸ ì¼ë°˜ ì§ˆë¬¸
            </div>
            <div
              class="example-btn"
              onclick="sendExample('ê°„ë‹¨í•œ ì‹œë¥¼ í•˜ë‚˜ ì¨ì£¼ì„¸ìš”')"
            >
              âœï¸ ì°½ì‘ ìš”ì²­
            </div>
            <div
              class="example-btn"
              onclick="sendExample('í”„ë¡œê·¸ë˜ë° ê³µë¶€ ë°©ë²• ì¶”ì²œí•´ì£¼ì„¸ìš”')"
            >
              ğŸ’» í•™ìŠµ ì¡°ì–¸
            </div>
            <div
              class="example-btn"
              onclick="sendExample('ì¬ë¯¸ìˆëŠ” ë†ë‹´ í•˜ë‚˜ í•´ì£¼ì„¸ìš”')"
            >
              ğŸ˜„ ë†ë‹´ ìš”ì²­
            </div>
            <div
              class="example-btn"
              onclick="sendExample('ê°„ë‹¨í•œ ìˆ˜í•™ ë¬¸ì œ ë‚´ì£¼ì„¸ìš”')"
            >
              ğŸ”¢ ìˆ˜í•™ ë¬¸ì œ
            </div>
          </div>

          <div class="controls">
            <button class="control-btn" onclick="testConnection()">
              ì—°ê²° í…ŒìŠ¤íŠ¸
            </button>
            <button class="control-btn" onclick="resetConnection()">
              ì—°ê²° ì´ˆê¸°í™”
            </button>
            <button class="control-btn" onclick="clearChat()">
              ëŒ€í™” ì´ˆê¸°í™”
            </button>
            <button
              class="control-btn"
              onclick="toggleVoiceMode()"
              id="voiceModeBtn"
            >
              ìŒì„± ëª¨ë“œ OFF
            </button>
            <select id="voiceSelect" class="control-btn">
              <option value="alloy">Alloy (ê¸°ë³¸)</option>
              <option value="echo">Echo</option>
              <option value="fable">Fable</option>
              <option value="onyx">Onyx</option>
              <option value="nova">Nova</option>
              <option value="shimmer">Shimmer</option>
            </select>
          </div>

          <div class="voice-controls" style="display: none" id="voiceControls">
            <button
              class="voice-btn"
              id="recordBtn"
              onclick="toggleRecording()"
            >
              ğŸ¤ ë…¹ìŒ ì‹œì‘
            </button>
            <span id="recordingStatus"
              >ìŒì„± ëª¨ë“œê°€ í™œì„±í™”ë˜ë©´ ìŒì„±ìœ¼ë¡œ ëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span
            >
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <textarea
              id="messageInput"
              placeholder="ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”... (ì˜ˆ: ì•ˆë…•í•˜ì„¸ìš”, ë„ì›€ì´ í•„ìš”í•´ìš”)"
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
              â¤
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let isConnected = false;
      let voiceMode = false;
      let isRecording = false;
      let currentBotMessageDiv = null;
      let audioContext = null;
      let mediaRecorder = null;
      let audioChunks = [];
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 5;
      let reconnectTimer = null;
      let connectionStable = false;

      // ì›¹ì†Œì¼“ ì—°ê²°
      function connectWebSocket() {
        // ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ìƒˆë¡œ ì—°ê²°í•˜ì§€ ì•ŠìŒ
        if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
          console.log("ì´ë¯¸ ì•ˆì •ì ìœ¼ë¡œ ì—°ê²°ë˜ì–´ ìˆìŒ");
          return;
        }

        // ê¸°ì¡´ ì†Œì¼“ì´ ìˆìœ¼ë©´ ì •ë¦¬
        if (socket) {
          socket.onopen = null;
          socket.onmessage = null;
          socket.onclose = null;
          socket.onerror = null;
          if (
            socket.readyState === WebSocket.OPEN ||
            socket.readyState === WebSocket.CONNECTING
          ) {
            socket.close();
          }
        }

        const wsUrl = "ws://localhost:3000/realtime-chat";
        console.log(
          `ìˆœìˆ˜ ì±—ë´‡ ì›¹ì†Œì¼“ ì—°ê²° ì‹œë„ (${
            reconnectAttempts + 1
          }/${maxReconnectAttempts}):`,
          wsUrl
        );

        socket = new WebSocket(wsUrl);

        socket.onopen = function (event) {
          console.log("ìˆœìˆ˜ ì±—ë´‡ ì—°ê²° ì„±ê³µ! ğŸ‰");
          updateStatus("connected", "ğŸŸ¢ ì—°ê²° ì•ˆì •");
          updateConnectionInfo(
            "âœ… ìˆœìˆ˜ ì±—ë´‡ ëª¨ë“œë¡œ ì•ˆì •ì ìœ¼ë¡œ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤! ììœ ë¡­ê²Œ ëŒ€í™”í•´ë³´ì„¸ìš”."
          );
          isConnected = true;
          connectionStable = true;
          reconnectAttempts = 0;

          // ì¬ì—°ê²° íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì œê±°
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }

          // ì²« ì—°ê²°ì‹œì—ë§Œ í™˜ì˜ ë©”ì‹œì§€ í‘œì‹œ
          if (!connectionStable || reconnectAttempts === 0) {
            addMessage(
              "bot",
              "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” UMate AIì…ë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ì—†ì´ ìˆœìˆ˜í•œ AIì™€ì˜ ëŒ€í™”ë¥¼ ì¦ê¸°ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ¤–",
              "AI ì–´ì‹œìŠ¤í„´íŠ¸"
            );
          } else {
            addMessage(
              "system",
              "ğŸ”„ ì—°ê²°ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€í™”ë¥¼ ê³„ì†í•´ì£¼ì„¸ìš”!"
            );
          }
        };

        socket.onmessage = function (event) {
          const data = JSON.parse(event.data);
          console.log("ğŸ“¨ ì„œë²„ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ :", data);

          switch (data.type) {
            case "connection":
              if (data.status === "connected") {
                console.log("ì—°ê²° í™•ì¸:", data.capabilities);
                if (data.capabilities && data.capabilities.audio) {
                  document.getElementById("voiceModeBtn").style.display =
                    "inline-block";
                }
              }
              break;

            case "text_delta":
              updateBotMessage(data.delta);
              break;

            case "text_done":
              finalizeBotMessage(data.text);
              break;

            case "chat_response":
              // ê°„ë‹¨í•œ Chat API ì‘ë‹µ ì²˜ë¦¬
              addMessage("bot", data.message);
              break;

            case "audio_delta":
              if (voiceMode && data.audio) {
                playAudioDelta(data.audio);
              }
              break;

            case "audio_transcript_delta":
              updateBotMessage(data.delta);
              break;

            case "audio_transcript_done":
              finalizeBotMessage(data.transcript);
              break;

            case "speech_started":
              addMessage("system", data.message);
              break;

            case "speech_stopped":
              addMessage("system", data.message);
              break;

            case "transcription_complete":
              addMessage("user", data.transcription, "ìŒì„± ì¸ì‹");
              break;

            case "assistant_message_start":
              startBotMessage(data.message);
              break;

            case "response_complete":
              console.log("ì‘ë‹µ ì™„ë£Œ");
              break;

            case "error":
              addMessage("system", "âŒ ì˜¤ë¥˜: " + data.error);
              break;

            default:
              console.log("ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë©”ì‹œì§€ íƒ€ì…:", data.type);
          }
        };

        socket.onclose = function (event) {
          console.log("ìˆœìˆ˜ ì±—ë´‡ ì—°ê²° ì¢…ë£Œ", event.code, event.reason);
          isConnected = false;
          connectionStable = false;

          // ì •ìƒ ì¢…ë£Œ(1000)ì´ê±°ë‚˜ ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í•œ ê²½ìš° ì¬ì—°ê²°í•˜ì§€ ì•ŠìŒ
          if (
            event.code === 1000 ||
            reconnectAttempts >= maxReconnectAttempts
          ) {
            updateStatus("disconnected", "ğŸ”´ ì—°ê²° ì¢…ë£Œ");
            updateConnectionInfo(
              event.code === 1000
                ? "ì—°ê²°ì´ ì •ìƒì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."
                : "ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
            );
            return;
          }

          reconnectAttempts++;
          const delay = Math.min(5000 * reconnectAttempts, 30000); // ìµœëŒ€ 30ì´ˆê¹Œì§€ ì§€ì—°

          updateStatus("disconnected", "ğŸ”„ ì¬ì—°ê²° ì¤‘...");
          updateConnectionInfo(
            `âŒ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ${
              delay / 1000
            }ì´ˆ í›„ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤... (${reconnectAttempts}/${maxReconnectAttempts})`
          );

          // ì´ì „ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì œê±°
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
          }

          // ì§€ì—° í›„ ì¬ì—°ê²° ì‹œë„
          reconnectTimer = setTimeout(() => {
            if (!isConnected && reconnectAttempts <= maxReconnectAttempts) {
              connectWebSocket();
            }
          }, delay);
        };

        socket.onerror = function (error) {
          console.error("ìˆœìˆ˜ ì±—ë´‡ ì›¹ì†Œì¼“ ì˜¤ë¥˜:", error);
          updateStatus("disconnected", "ğŸ”´ ì—°ê²° ì˜¤ë¥˜");
          updateConnectionInfo(
            "âŒ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. chatbot.jsê°€ í¬íŠ¸ 3000ì—ì„œ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
          isConnected = false;
          connectionStable = false;
        };
      }

      // ìƒíƒœ ì—…ë°ì´íŠ¸
      function updateStatus(status, text) {
        const statusEl = document.getElementById("status");
        statusEl.className = `status ${status}`;
        statusEl.textContent = text;
      }

      // ì—°ê²° ì •ë³´ ì—…ë°ì´íŠ¸
      function updateConnectionInfo(message) {
        const infoEl = document.getElementById("connectionInfo");
        infoEl.textContent = message;
      }

      // ë©”ì‹œì§€ ì „ì†¡
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        console.log("ğŸ” sendMessage í˜¸ì¶œë¨");
        console.log("ğŸ“ ë©”ì‹œì§€:", message);
        console.log("ğŸ”— ì—°ê²° ìƒíƒœ:", isConnected);
        console.log("ğŸŒ ì†Œì¼“ ìƒíƒœ:", socket ? socket.readyState : "ì†Œì¼“ ì—†ìŒ");

        if (!message) {
          console.log("âŒ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŒ");
          return;
        }

        if (!isConnected) {
          console.log("âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ");
          addMessage(
            "system",
            "âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        if (!socket || socket.readyState !== WebSocket.OPEN) {
          console.log("âŒ ì†Œì¼“ì´ ì—´ë ¤ìˆì§€ ì•ŠìŒ");
          addMessage(
            "system",
            "âŒ WebSocket ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        console.log("âœ… ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘");
        addMessage("user", message);
        input.value = "";
        input.style.height = "auto";

        try {
          // ì›¹ì†Œì¼“ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          const messageData = {
            type: "user_message",
            message: message,
          };
          console.log("ğŸ“¤ ì „ì†¡í•  ë°ì´í„°:", messageData);

          socket.send(JSON.stringify(messageData));
          console.log("âœ… ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");

          // ì „ì†¡ í›„ ì†Œì¼“ ìƒíƒœ ì¬í™•ì¸
          setTimeout(() => {
            console.log("ğŸ” ì „ì†¡ í›„ ì†Œì¼“ ìƒíƒœ:", socket.readyState);
            console.log("ğŸ” ì „ì†¡ í›„ ì—°ê²° ìƒíƒœ:", isConnected);
          }, 100);
        } catch (error) {
          console.error("âŒ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error);
          addMessage(
            "system",
            "âŒ ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
          );
        }
      }

      // ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡
      function sendExample(message) {
        console.log("ğŸ” sendExample í˜¸ì¶œë¨:", message);
        console.log("ğŸ”— ì—°ê²° ìƒíƒœ:", isConnected);
        console.log("ğŸŒ ì†Œì¼“ ìƒíƒœ:", socket ? socket.readyState : "ì†Œì¼“ ì—†ìŒ");

        if (!isConnected) {
          console.log("âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ - ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€");
          addMessage(
            "system",
            "âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        if (!socket || socket.readyState !== WebSocket.OPEN) {
          console.log("âŒ ì†Œì¼“ì´ ì—´ë ¤ìˆì§€ ì•ŠìŒ - ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ë¶ˆê°€");
          addMessage(
            "system",
            "âŒ WebSocket ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì¬ì—°ê²°ì„ ì‹œë„í•´ì£¼ì„¸ìš”."
          );
          return;
        }

        console.log("âœ… ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ì‹œì‘");
        addMessage("user", message);

        try {
          const messageData = {
            type: "user_message",
            message: message,
          };
          console.log("ğŸ“¤ ì „ì†¡í•  ì˜ˆì‹œ ë°ì´í„°:", messageData);

          socket.send(JSON.stringify(messageData));
          console.log("âœ… ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ì™„ë£Œ");
        } catch (error) {
          console.error("âŒ ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:", error);
          addMessage(
            "system",
            "âŒ ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
          );
        }
      }

      // ë©”ì‹œì§€ ì¶”ê°€
      function addMessage(type, content, info = "") {
        const messagesContainer = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.textContent = content;

        if (info) {
          const infoDiv = document.createElement("div");
          infoDiv.style.fontSize = "11px";
          infoDiv.style.opacity = "0.7";
          infoDiv.style.marginTop = "5px";
          infoDiv.textContent = info;
          contentDiv.appendChild(infoDiv);
        }

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // ë´‡ ë©”ì‹œì§€ ì‹œì‘
      function startBotMessage(initialText = "") {
        const messagesContainer = document.getElementById("messages");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message bot";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.textContent = initialText;

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        currentBotMessageDiv = contentDiv;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // ë´‡ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸
      function updateBotMessage(delta) {
        if (!currentBotMessageDiv) {
          startBotMessage();
        }

        currentBotMessageDiv.textContent += delta;
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      // ë´‡ ë©”ì‹œì§€ ì™„ë£Œ
      function finalizeBotMessage(finalText) {
        if (currentBotMessageDiv && finalText) {
          currentBotMessageDiv.textContent = finalText;
        }
        currentBotMessageDiv = null;
      }

      // ìŒì„± ëª¨ë“œ í† ê¸€
      function toggleVoiceMode() {
        voiceMode = !voiceMode;
        const btn = document.getElementById("voiceModeBtn");
        const controls = document.getElementById("voiceControls");

        if (voiceMode) {
          btn.textContent = "ìŒì„± ëª¨ë“œ ON";
          btn.classList.add("active");
          controls.style.display = "flex";
          initAudioContext();
        } else {
          btn.textContent = "ìŒì„± ëª¨ë“œ OFF";
          btn.classList.remove("active");
          controls.style.display = "none";
          if (isRecording) {
            stopRecording();
          }
        }
      }

      // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
      }

      // ë…¹ìŒ í† ê¸€
      function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      // ë…¹ìŒ ì‹œì‘
      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            sendAudioToServer(audioBlob);
          };

          mediaRecorder.start();
          isRecording = true;

          const btn = document.getElementById("recordBtn");
          btn.textContent = "ğŸ›‘ ë…¹ìŒ ì¤‘ì§€";
          btn.classList.add("recording");

          document.getElementById("recordingStatus").textContent =
            "ğŸ¤ ë…¹ìŒ ì¤‘... ë§ì”€ì„ ë§ˆì¹˜ì‹œë©´ ì¤‘ì§€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        } catch (error) {
          console.error("ë…¹ìŒ ì‹œì‘ ì˜¤ë¥˜:", error);
          addMessage("system", "âŒ ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
        }
      }

      // ë…¹ìŒ ì¤‘ì§€
      function stopRecording() {
        if (mediaRecorder) {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach((track) => track.stop());
        }

        isRecording = false;

        const btn = document.getElementById("recordBtn");
        btn.textContent = "ğŸ¤ ë…¹ìŒ ì‹œì‘";
        btn.classList.remove("recording");

        document.getElementById("recordingStatus").textContent =
          "ìŒì„± ì²˜ë¦¬ ì¤‘...";
      }

      // ì„œë²„ë¡œ ì˜¤ë””ì˜¤ ì „ì†¡ (ì‹¤ì œ êµ¬í˜„)
      async function sendAudioToServer(audioBlob) {
        if (!isConnected || !socket || socket.readyState !== WebSocket.OPEN) {
          addMessage("system", "âŒ ì„œë²„ì— ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          document.getElementById("recordingStatus").textContent =
            "ìŒì„± ëª¨ë“œ í™œì„±í™”ë¨";
          return;
        }

        try {
          console.log("ğŸ¤ ì˜¤ë””ì˜¤ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘:", audioBlob.size, "bytes");
          addMessage("system", "ğŸ”„ ìŒì„±ì„ ì„œë²„ë¡œ ì „ì†¡í•˜ê³  ìˆìŠµë‹ˆë‹¤...");

          // AudioBufferë¡œ ë³€í™˜
          const arrayBuffer = await audioBlob.arrayBuffer();
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          // PCM16 í˜•ì‹ìœ¼ë¡œ ë³€í™˜
          const pcm16Data = convertToPCM16(audioBuffer);

          // Base64ë¡œ ì¸ì½”ë”©
          const base64Audio = arrayBufferToBase64(pcm16Data);

          // WebSocketìœ¼ë¡œ ì „ì†¡
          socket.send(
            JSON.stringify({
              type: "audio_data",
              audio: base64Audio,
            })
          );

          // ì˜¤ë””ì˜¤ ì „ì†¡ ì™„ë£Œ ì‹ í˜¸
          socket.send(
            JSON.stringify({
              type: "audio_commit",
            })
          );

          console.log("ğŸ“¡ ì˜¤ë””ì˜¤ ì „ì†¡ ì™„ë£Œ:", base64Audio.length, "characters");

          document.getElementById("recordingStatus").textContent =
            "ğŸ”„ ìŒì„± ì‘ë‹µì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...";
        } catch (error) {
          console.error("âŒ ì˜¤ë””ì˜¤ ì „ì†¡ ì˜¤ë¥˜:", error);
          addMessage(
            "system",
            "âŒ ìŒì„± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message
          );
          document.getElementById("recordingStatus").textContent =
            "ìŒì„± ëª¨ë“œ í™œì„±í™”ë¨";
        }
      }

      // AudioBufferë¥¼ PCM16ìœ¼ë¡œ ë³€í™˜
      function convertToPCM16(audioBuffer) {
        const length = audioBuffer.length;
        const pcm16 = new Int16Array(length);
        const channelData = audioBuffer.getChannelData(0); // ì²« ë²ˆì§¸ ì±„ë„ ì‚¬ìš©

        for (let i = 0; i < length; i++) {
          // Float32ë¥¼ Int16ìœ¼ë¡œ ë³€í™˜ (-1.0 ~ 1.0 â†’ -32768 ~ 32767)
          const sample = Math.max(-1, Math.min(1, channelData[i]));
          pcm16[i] = sample < 0 ? sample * 0x8000 : sample * 0x7fff;
        }

        return pcm16.buffer;
      }

      // ArrayBufferë¥¼ Base64ë¡œ ë³€í™˜
      function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }

      // ì˜¤ë””ì˜¤ ì¬ìƒ (ì‹¤ì œ êµ¬í˜„)
      let audioQueue = [];
      let isPlayingAudio = false;
      let currentAudioContext = null;

      function playAudioDelta(audioData) {
        console.log("ğŸ”Š ì˜¤ë””ì˜¤ ì¬ìƒ:", audioData.length, "characters");

        try {
          // Base64 ë””ì½”ë”©
          const binaryString = window.atob(audioData);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          // PCM16 ë°ì´í„°ë¥¼ AudioBufferë¡œ ë³€í™˜
          const pcm16Data = new Int16Array(bytes.buffer);

          // ì˜¤ë””ì˜¤ íì— ì¶”ê°€
          audioQueue.push(pcm16Data);

          // ì¬ìƒ ì¤‘ì´ ì•„ë‹ˆë©´ ì¬ìƒ ì‹œì‘
          if (!isPlayingAudio) {
            playNextAudio();
          }
        } catch (error) {
          console.error("âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:", error);
        }
      }

      async function playNextAudio() {
        if (audioQueue.length === 0) {
          isPlayingAudio = false;
          return;
        }

        isPlayingAudio = true;

        try {
          if (!currentAudioContext) {
            currentAudioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }

          const pcm16Data = audioQueue.shift();

          // PCM16ë¥¼ Float32ë¡œ ë³€í™˜
          const floatData = new Float32Array(pcm16Data.length);
          for (let i = 0; i < pcm16Data.length; i++) {
            floatData[i] = pcm16Data[i] / 32768.0;
          }

          // AudioBuffer ìƒì„± (ìƒ˜í”Œë§ ë ˆì´íŠ¸ 24000Hz, ëª¨ë…¸)
          const audioBuffer = currentAudioContext.createBuffer(
            1,
            floatData.length,
            24000
          );
          audioBuffer.getChannelData(0).set(floatData);

          // AudioSource ìƒì„± ë° ì¬ìƒ
          const source = currentAudioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(currentAudioContext.destination);

          source.onended = () => {
            // ë‹¤ìŒ ì˜¤ë””ì˜¤ ì¬ìƒ
            setTimeout(() => playNextAudio(), 10);
          };

          source.start();
        } catch (error) {
          console.error("âŒ ì˜¤ë””ì˜¤ ì¬ìƒ ì²˜ë¦¬ ì˜¤ë¥˜:", error);
          isPlayingAudio = false;
        }
      }

      // ì—°ê²° í…ŒìŠ¤íŠ¸
      function testConnection() {
        if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
          addMessage(
            "system",
            `âœ… ì—°ê²° ìƒíƒœ ì–‘í˜¸! WebSocketì´ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™ ì¤‘ì…ë‹ˆë‹¤.
ğŸ“Š ìƒíƒœ: ${connectionStable ? "ì•ˆì •" : "ë¶ˆì•ˆì •"}
ğŸ”„ ì¬ì—°ê²° ì‹œë„: ${reconnectAttempts}/${maxReconnectAttempts}
ğŸ”— WebSocket ìƒíƒœ: ${socket.readyState === WebSocket.OPEN ? "OPEN" : "CLOSED"}`
          );
        } else if (socket && socket.readyState === WebSocket.CONNECTING) {
          addMessage("system", "ğŸ”„ ì—°ê²° ì‹œë„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...");
        } else {
          addMessage(
            "system",
            `âŒ ì—°ê²°ë˜ì§€ ì•ŠìŒ. ë‹¤ìŒì„ í™•ì¸í•´ì£¼ì„¸ìš”:
1. npm run dev ëª…ë ¹ìœ¼ë¡œ chatbot.jsê°€ ì‹¤í–‰ ì¤‘ì¸ì§€
2. í¬íŠ¸ 3000ì´ ì‚¬ìš© ê°€ëŠ¥í•œì§€
3. ë°©í™”ë²½ ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€
ğŸ”„ ì¬ì—°ê²° ì‹œë„: ${reconnectAttempts}/${maxReconnectAttempts}`
          );

          // ìˆ˜ë™ ì¬ì—°ê²° ì‹œë„
          if (reconnectAttempts < maxReconnectAttempts) {
            addMessage("system", "ğŸ”„ ìˆ˜ë™ ì¬ì—°ê²°ì„ ì‹œë„í•©ë‹ˆë‹¤...");
            setTimeout(() => connectWebSocket(), 1000);
          }
        }
      }

      // ëŒ€í™” ì´ˆê¸°í™”
      function clearChat() {
        const messages = document.getElementById("messages");
        const systemElements = messages.querySelectorAll(
          ".welcome-section, .features, .connection-info, .quick-examples, .controls, .voice-controls"
        );
        messages.innerHTML = "";

        // ì‹œìŠ¤í…œ ìš”ì†Œë“¤ ë‹¤ì‹œ ì¶”ê°€
        systemElements.forEach((el) => messages.appendChild(el));

        addMessage(
          "bot",
          "ëŒ€í™”ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ëŒ€í™”ë¥¼ ì‹œì‘í•´ë³´ì„¸ìš”! ğŸ”„",
          "AI ì–´ì‹œìŠ¤í„´íŠ¸"
        );
      }

      // ì—°ê²° ì´ˆê¸°í™” (ì™„ì „ ì¬ì‹œì‘)
      function resetConnection() {
        console.log("ì—°ê²° ì™„ì „ ì´ˆê¸°í™” ì‹œì‘...");

        // ëª¨ë“  íƒ€ì´ë¨¸ ì •ë¦¬
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }

        // ì†Œì¼“ ì •ë¦¬
        if (socket) {
          socket.onopen = null;
          socket.onmessage = null;
          socket.onclose = null;
          socket.onerror = null;
          if (
            socket.readyState === WebSocket.OPEN ||
            socket.readyState === WebSocket.CONNECTING
          ) {
            socket.close(1000, "Manual reset");
          }
          socket = null;
        }

        // ìƒíƒœ ì´ˆê¸°í™”
        isConnected = false;
        connectionStable = false;
        reconnectAttempts = 0;

        updateStatus("disconnected", "ğŸ”„ ì´ˆê¸°í™” ì¤‘...");
        updateConnectionInfo("ì—°ê²°ì„ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ê³  ìƒˆë¡œ ì—°ê²°í•©ë‹ˆë‹¤...");

        // 1ì´ˆ í›„ ìƒˆë¡œ ì—°ê²°
        setTimeout(() => {
          connectWebSocket();
        }, 1000);
      }

      // ìŒì„± ë³€ê²½
      document
        .getElementById("voiceSelect")
        .addEventListener("change", function () {
          if (isConnected) {
            socket.send(
              JSON.stringify({
                type: "voice_change",
                voice: this.value,
              })
            );
            addMessage("system", `ìŒì„±ì´ ${this.value}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
          }
        });

      // ì…ë ¥ì°½ ìë™ í¬ê¸° ì¡°ì ˆ
      document
        .getElementById("messageInput")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });

      // ì—”í„°í‚¤ë¡œ ì „ì†¡
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° (í•œ ë²ˆë§Œ)
      window.addEventListener("load", function () {
        console.log("í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ - ì´ˆê¸° ì—°ê²° ì‹œì‘");
        // ì´ˆê¸° ìƒíƒœ ì„¤ì •
        reconnectAttempts = 0;
        connectionStable = false;

        // ì´ˆê¸° ì—°ê²° ì‹œë„
        setTimeout(() => {
          connectWebSocket();
        }, 500); // í˜ì´ì§€ ë¡œë“œ í›„ ì•½ê°„ ì§€ì—°
      });

      // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
      window.addEventListener("beforeunload", function () {
        console.log("í˜ì´ì§€ ì–¸ë¡œë“œ - ì—°ê²° ì •ë¦¬");

        // íƒ€ì´ë¨¸ ì •ë¦¬
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }

        // ì†Œì¼“ ì •ë¦¬
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close(1000, "Page unload");
        }
      });
    </script>
  </body>
</html>
