<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UMate AI - ÏàúÏàò Ï±óÎ¥á ÌÖåÏä§Ìä∏</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 800px;
        height: 85vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        padding: 25px;
        text-align: center;
        position: relative;
      }

      .header h1 {
        font-size: 28px;
        margin-bottom: 8px;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        font-size: 16px;
      }

      .pure-badge {
        position: absolute;
        top: 12px;
        left: 20px;
        background: rgba(255, 255, 255, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 20px;
        padding: 6px 14px;
        font-size: 11px;
        font-weight: bold;
      }

      .status {
        position: absolute;
        top: 18px;
        right: 20px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      .status.connected {
        background: rgba(34, 197, 94, 0.25);
        border: 1px solid rgba(34, 197, 94, 0.4);
        color: #16a34a;
      }

      .status.disconnected {
        background: rgba(239, 68, 68, 0.25);
        border: 1px solid rgba(239, 68, 68, 0.4);
        color: #dc2626;
      }

      .chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .messages {
        flex: 1;
        overflow-y: auto;
        padding: 25px;
        background: #f8fafc;
      }

      .welcome-section {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
      }

      .welcome-section h3 {
        margin-bottom: 10px;
        font-size: 18px;
      }

      .features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .feature-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        transition: transform 0.2s;
      }

      .feature-card:hover {
        transform: translateY(-2px);
      }

      .feature-card h4 {
        color: #4f46e5;
        margin-bottom: 5px;
        font-size: 14px;
      }

      .feature-card p {
        color: #6b7280;
        font-size: 12px;
      }

      .quick-examples {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
        margin-bottom: 20px;
      }

      .example-btn {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 12px;
        padding: 12px 16px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s;
        text-align: center;
      }

      .example-btn:hover {
        background: #e5e7eb;
        transform: translateY(-1px);
      }

      .message {
        margin-bottom: 20px;
        display: flex;
        animation: slideIn 0.4s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .message.user {
        justify-content: flex-end;
      }

      .message-content {
        max-width: 75%;
        padding: 15px 20px;
        border-radius: 20px;
        font-size: 15px;
        line-height: 1.6;
        position: relative;
      }

      .user .message-content {
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
      }

      .bot .message-content {
        background: white;
        color: #374151;
        border: 1px solid #e5e7eb;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .system .message-content {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fbbf24;
        font-size: 13px;
        max-width: 90%;
        margin: 0 auto;
      }

      .typing-indicator {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        max-width: 75%;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .typing-dots {
        display: flex;
        gap: 6px;
        margin-right: 10px;
      }

      .typing-dots span {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: #9ca3af;
        animation: typing 1.6s infinite ease-in-out;
      }

      .typing-dots span:nth-child(1) {
        animation-delay: -0.32s;
      }
      .typing-dots span:nth-child(2) {
        animation-delay: -0.16s;
      }

      @keyframes typing {
        0%,
        80%,
        100% {
          transform: scale(0.8);
          opacity: 0.5;
        }
        40% {
          transform: scale(1.2);
          opacity: 1;
        }
      }

      .controls {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .control-btn {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .control-btn:hover {
        background: #f3f4f6;
        transform: translateY(-1px);
      }

      .control-btn.active {
        background: #4f46e5;
        color: white;
        border-color: #4f46e5;
      }

      .input-container {
        padding: 25px;
        background: white;
        border-top: 1px solid #e5e7eb;
      }

      .input-wrapper {
        display: flex;
        gap: 12px;
        align-items: flex-end;
      }

      #messageInput {
        flex: 1;
        padding: 15px 20px;
        border: 2px solid #e5e7eb;
        border-radius: 25px;
        font-size: 15px;
        resize: none;
        min-height: 50px;
        max-height: 120px;
        font-family: inherit;
        outline: none;
        transition: border-color 0.3s;
      }

      #messageInput:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      }

      .send-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: linear-gradient(135deg, #4f46e5, #7c3aed);
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        font-size: 18px;
        box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
      }

      .send-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
      }

      .send-btn:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .voice-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
      }

      .voice-btn {
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .voice-btn.recording {
        background: #ef4444;
        color: white;
        border-color: #ef4444;
      }

      .connection-info {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 10px;
        padding: 12px;
        margin-bottom: 15px;
        font-size: 12px;
        color: #0369a1;
      }

      @media (max-width: 768px) {
        .container {
          height: 100vh;
          border-radius: 0;
        }

        .header {
          padding: 20px;
        }

        .header h1 {
          font-size: 24px;
        }

        .message-content {
          max-width: 85%;
        }

        .features {
          grid-template-columns: 1fr;
        }

        .quick-examples {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="pure-badge">PURE CHATBOT</div>
        <h1>ü§ñ UMate AI Assistant</h1>
        <p>ÏàúÏàò Ï±óÎ¥á Î™®Îìú - OpenAI API ÏßÅÏ†ë Ïó∞Í≤∞</p>
        <div class="status disconnected" id="status">Ïó∞Í≤∞ Ï§ë...</div>
      </div>

      <div class="chat-container">
        <div class="messages" id="messages">
          <div class="welcome-section">
            <h3>üöÄ ÏàúÏàò Ï±óÎ¥á Î™®Îìú</h3>
            <p>Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏóÜÏù¥ OpenAI GPT-4o miniÏôÄ ÏßÅÏ†ë ÎåÄÌôîÌïòÏÑ∏Ïöî!</p>
          </div>

          <div class="features">
            <div class="feature-card">
              <h4>‚ö° Ïã§ÏãúÍ∞Ñ Ïä§Ìä∏Î¶¨Î∞ç</h4>
              <p>ÌÉÄÏù¥ÌïëÌïòÎìØ ÎãµÎ≥Ä ÏÉùÏÑ±</p>
            </div>
            <div class="feature-card">
              <h4>üé§ ÏùåÏÑ± ÏßÄÏõê</h4>
              <p>ÎßêÌïòÍ∏∞ & Îì£Í∏∞ Í∞ÄÎä•</p>
            </div>
            <div class="feature-card">
              <h4>üß† GPT-4o mini</h4>
              <p>ÏµúÏã† AI Î™®Îç∏ ÏÇ¨Ïö©</p>
            </div>
            <div class="feature-card">
              <h4>üí¨ ÏûêÏó∞Ïä§Îü¨Ïö¥ ÎåÄÌôî</h4>
              <p>ÌïúÍµ≠Ïñ¥ ÏôÑÎ≤Ω ÏßÄÏõê</p>
            </div>
          </div>

          <div class="connection-info" id="connectionInfo">
            üì° WebSocket Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë... Ìè¨Ìä∏ 3000ÏóêÏÑú chatbot.jsÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ
            ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.
          </div>

          <div class="quick-examples">
            <div
              class="example-btn"
              onclick="sendExample('ÏïàÎÖïÌïòÏÑ∏Ïöî! ÏûêÍ∏∞ÏÜåÍ∞ú Ìï¥Ï£ºÏÑ∏Ïöî')"
            >
              üëã Ïù∏ÏÇ¨ & ÏÜåÍ∞ú
            </div>
            <div
              class="example-btn"
              onclick="sendExample('Ïò§Îäò ÎÇ†Ïî®Í∞Ä Ïñ¥Îñ§Í∞ÄÏöî?')"
            >
              üå§Ô∏è ÏùºÎ∞ò ÏßàÎ¨∏
            </div>
            <div
              class="example-btn"
              onclick="sendExample('Í∞ÑÎã®Ìïú ÏãúÎ•º ÌïòÎÇò Ïç®Ï£ºÏÑ∏Ïöî')"
            >
              ‚úçÔ∏è Ï∞ΩÏûë ÏöîÏ≤≠
            </div>
            <div
              class="example-btn"
              onclick="sendExample('ÌîÑÎ°úÍ∑∏ÎûòÎ∞ç Í≥µÎ∂Ä Î∞©Î≤ï Ï∂îÏ≤úÌï¥Ï£ºÏÑ∏Ïöî')"
            >
              üíª ÌïôÏäµ Ï°∞Ïñ∏
            </div>
            <div
              class="example-btn"
              onclick="sendExample('Ïû¨ÎØ∏ÏûàÎäî ÎÜçÎã¥ ÌïòÎÇò Ìï¥Ï£ºÏÑ∏Ïöî')"
            >
              üòÑ ÎÜçÎã¥ ÏöîÏ≤≠
            </div>
            <div
              class="example-btn"
              onclick="sendExample('Í∞ÑÎã®Ìïú ÏàòÌïô Î¨∏Ï†ú ÎÇ¥Ï£ºÏÑ∏Ïöî')"
            >
              üî¢ ÏàòÌïô Î¨∏Ï†ú
            </div>
          </div>

          <div class="controls">
            <button class="control-btn" onclick="testConnection()">
              Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
            </button>
            <button class="control-btn" onclick="resetConnection()">
              Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî
            </button>
            <button class="control-btn" onclick="clearChat()">
              ÎåÄÌôî Ï¥àÍ∏∞Ìôî
            </button>
            <button
              class="control-btn"
              onclick="toggleVoiceMode()"
              id="voiceModeBtn"
            >
              ÏùåÏÑ± Î™®Îìú OFF
            </button>
            <select id="voiceSelect" class="control-btn">
              <option value="alloy">Alloy (Í∏∞Î≥∏)</option>
              <option value="echo">Echo</option>
              <option value="fable">Fable</option>
              <option value="onyx">Onyx</option>
              <option value="nova">Nova</option>
              <option value="shimmer">Shimmer</option>
            </select>
          </div>

          <div class="voice-controls" style="display: none" id="voiceControls">
            <button
              class="voice-btn"
              id="recordBtn"
              onclick="toggleRecording()"
            >
              üé§ ÎÖπÏùå ÏãúÏûë
            </button>
            <span id="recordingStatus"
              >ÏùåÏÑ± Î™®ÎìúÍ∞Ä ÌôúÏÑ±ÌôîÎêòÎ©¥ ÏùåÏÑ±ÏúºÎ°ú ÎåÄÌôîÌï† Ïàò ÏûàÏäµÎãàÎã§.</span
            >
          </div>
        </div>

        <div class="input-container">
          <div class="input-wrapper">
            <textarea
              id="messageInput"
              placeholder="Î¨¥ÏóáÏù¥Îì† Î¨ºÏñ¥Î≥¥ÏÑ∏Ïöî... (Ïòà: ÏïàÎÖïÌïòÏÑ∏Ïöî, ÎèÑÏõÄÏù¥ ÌïÑÏöîÌï¥Ïöî)"
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
              ‚û§
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let socket = null;
      let isConnected = false;
      let voiceMode = false;
      let isRecording = false;
      let currentBotMessageDiv = null;
      let audioContext = null;
      let mediaRecorder = null;
      let audioChunks = [];
      let reconnectAttempts = 0;
      let maxReconnectAttempts = 5;
      let reconnectTimer = null;
      let connectionStable = false;

      // ÏõπÏÜåÏºì Ïó∞Í≤∞
      function connectWebSocket() {
        // Ïù¥ÎØ∏ Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏúºÎ©¥ ÏÉàÎ°ú Ïó∞Í≤∞ÌïòÏßÄ ÏïäÏùå
        if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
          console.log("Ïù¥ÎØ∏ ÏïàÏ†ïÏ†ÅÏúºÎ°ú Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏùå");
          return;
        }

        // Í∏∞Ï°¥ ÏÜåÏºìÏù¥ ÏûàÏúºÎ©¥ Ï†ïÎ¶¨
        if (socket) {
          socket.onopen = null;
          socket.onmessage = null;
          socket.onclose = null;
          socket.onerror = null;
          if (
            socket.readyState === WebSocket.OPEN ||
            socket.readyState === WebSocket.CONNECTING
          ) {
            socket.close();
          }
        }

        const wsUrl = "ws://localhost:3000/realtime-chat";
        console.log(
          `ÏàúÏàò Ï±óÎ¥á ÏõπÏÜåÏºì Ïó∞Í≤∞ ÏãúÎèÑ (${
            reconnectAttempts + 1
          }/${maxReconnectAttempts}):`,
          wsUrl
        );

        socket = new WebSocket(wsUrl);

        socket.onopen = function (event) {
          console.log("ÏàúÏàò Ï±óÎ¥á Ïó∞Í≤∞ ÏÑ±Í≥µ! üéâ");
          updateStatus("connected", "üü¢ Ïó∞Í≤∞ ÏïàÏ†ï");
          updateConnectionInfo(
            "‚úÖ ÏàúÏàò Ï±óÎ¥á Î™®ÎìúÎ°ú ÏïàÏ†ïÏ†ÅÏúºÎ°ú Ïó∞Í≤∞ÎêòÏóàÏäµÎãàÎã§! ÏûêÏú†Î°≠Í≤å ÎåÄÌôîÌï¥Î≥¥ÏÑ∏Ïöî."
          );
          isConnected = true;
          connectionStable = true;
          reconnectAttempts = 0;

          // Ïû¨Ïó∞Í≤∞ ÌÉÄÏù¥Î®∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
          }

          // Ï≤´ Ïó∞Í≤∞ÏãúÏóêÎßå ÌôòÏòÅ Î©îÏãúÏßÄ ÌëúÏãú
          if (!connectionStable || reconnectAttempts === 0) {
            addMessage(
              "bot",
              "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî UMate AIÏûÖÎãàÎã§. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏóÜÏù¥ ÏàúÏàòÌïú AIÏôÄÏùò ÎåÄÌôîÎ•º Ï¶êÍ∏∞Ïã§ Ïàò ÏûàÏäµÎãàÎã§. Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî? ü§ñ",
              "AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏"
            );
          } else {
            addMessage(
              "system",
              "üîÑ Ïó∞Í≤∞Ïù¥ Î≥µÍµ¨ÎêòÏóàÏäµÎãàÎã§. ÎåÄÌôîÎ•º Í≥ÑÏÜçÌï¥Ï£ºÏÑ∏Ïöî!"
            );
          }
        };

        socket.onmessage = function (event) {
          const data = JSON.parse(event.data);
          console.log("üì® ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î©îÏãúÏßÄ ÏàòÏã†:", data);

          switch (data.type) {
            case "connection":
              if (data.status === "connected") {
                console.log("Ïó∞Í≤∞ ÌôïÏù∏:", data.capabilities);
                if (data.capabilities && data.capabilities.audio) {
                  document.getElementById("voiceModeBtn").style.display =
                    "inline-block";
                }
              }
              break;

            case "text_delta":
              updateBotMessage(data.delta);
              break;

            case "text_done":
              finalizeBotMessage(data.text);
              break;

            case "chat_response":
              // Í∞ÑÎã®Ìïú Chat API ÏùëÎãµ Ï≤òÎ¶¨
              addMessage("bot", data.message);
              break;

            case "audio_delta":
              if (voiceMode && data.audio) {
                playAudioDelta(data.audio);
              }
              break;

            case "audio_transcript_delta":
              updateBotMessage(data.delta);
              break;

            case "audio_transcript_done":
              finalizeBotMessage(data.transcript);
              break;

            case "speech_started":
              addMessage("system", data.message);
              break;

            case "speech_stopped":
              addMessage("system", data.message);
              break;

            case "transcription_complete":
              addMessage("user", data.transcription, "ÏùåÏÑ± Ïù∏Ïãù");
              break;

            case "assistant_message_start":
              startBotMessage(data.message);
              break;

            case "response_complete":
              console.log("ÏùëÎãµ ÏôÑÎ£å");
              break;

            case "error":
              addMessage("system", "‚ùå Ïò§Î•ò: " + data.error);
              break;

            default:
              console.log("Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ Î©îÏãúÏßÄ ÌÉÄÏûÖ:", data.type);
          }
        };

        socket.onclose = function (event) {
          console.log("ÏàúÏàò Ï±óÎ¥á Ïó∞Í≤∞ Ï¢ÖÎ£å", event.code, event.reason);
          isConnected = false;
          connectionStable = false;

          // Ï†ïÏÉÅ Ï¢ÖÎ£å(1000)Ïù¥Í±∞ÎÇò ÏµúÎåÄ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ÌöüÏàòÎ•º Ï¥àÍ≥ºÌïú Í≤ΩÏö∞ Ïû¨Ïó∞Í≤∞ÌïòÏßÄ ÏïäÏùå
          if (
            event.code === 1000 ||
            reconnectAttempts >= maxReconnectAttempts
          ) {
            updateStatus("disconnected", "üî¥ Ïó∞Í≤∞ Ï¢ÖÎ£å");
            updateConnectionInfo(
              event.code === 1000
                ? "Ïó∞Í≤∞Ïù¥ Ï†ïÏÉÅÏ†ÅÏúºÎ°ú Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§."
                : "ÏµúÎåÄ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ ÌöüÏàòÎ•º Ï¥àÍ≥ºÌñàÏäµÎãàÎã§. ÏÉàÎ°úÍ≥†Ïπ® ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."
            );
            return;
          }

          reconnectAttempts++;
          const delay = Math.min(5000 * reconnectAttempts, 30000); // ÏµúÎåÄ 30Ï¥àÍπåÏßÄ ÏßÄÏó∞

          updateStatus("disconnected", "üîÑ Ïû¨Ïó∞Í≤∞ Ï§ë...");
          updateConnectionInfo(
            `‚ùå Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. ${
              delay / 1000
            }Ï¥à ÌõÑ Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§... (${reconnectAttempts}/${maxReconnectAttempts})`
          );

          // Ïù¥Ï†Ñ ÌÉÄÏù¥Î®∏Í∞Ä ÏûàÏúºÎ©¥ Ï†úÍ±∞
          if (reconnectTimer) {
            clearTimeout(reconnectTimer);
          }

          // ÏßÄÏó∞ ÌõÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
          reconnectTimer = setTimeout(() => {
            if (!isConnected && reconnectAttempts <= maxReconnectAttempts) {
              connectWebSocket();
            }
          }, delay);
        };

        socket.onerror = function (error) {
          console.error("ÏàúÏàò Ï±óÎ¥á ÏõπÏÜåÏºì Ïò§Î•ò:", error);
          updateStatus("disconnected", "üî¥ Ïó∞Í≤∞ Ïò§Î•ò");
          updateConnectionInfo(
            "‚ùå Ïó∞Í≤∞ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. chatbot.jsÍ∞Ä Ìè¨Ìä∏ 3000ÏóêÏÑú Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
          );
          isConnected = false;
          connectionStable = false;
        };
      }

      // ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      function updateStatus(status, text) {
        const statusEl = document.getElementById("status");
        statusEl.className = `status ${status}`;
        statusEl.textContent = text;
      }

      // Ïó∞Í≤∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
      function updateConnectionInfo(message) {
        const infoEl = document.getElementById("connectionInfo");
        infoEl.textContent = message;
      }

      // Î©îÏãúÏßÄ Ï†ÑÏÜ°
      function sendMessage() {
        const input = document.getElementById("messageInput");
        const message = input.value.trim();

        console.log("üîç sendMessage Ìò∏Ï∂úÎê®");
        console.log("üìù Î©îÏãúÏßÄ:", message);
        console.log("üîó Ïó∞Í≤∞ ÏÉÅÌÉú:", isConnected);
        console.log("üåê ÏÜåÏºì ÏÉÅÌÉú:", socket ? socket.readyState : "ÏÜåÏºì ÏóÜÏùå");

        if (!message) {
          console.log("‚ùå Î©îÏãúÏßÄÍ∞Ä ÎπÑÏñ¥ÏûàÏùå");
          return;
        }

        if (!isConnected) {
          console.log("‚ùå Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå");
          addMessage(
            "system",
            "‚ùå ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
          );
          return;
        }

        if (!socket || socket.readyState !== WebSocket.OPEN) {
          console.log("‚ùå ÏÜåÏºìÏù¥ Ïó¥Î†§ÏûàÏßÄ ÏïäÏùå");
          addMessage(
            "system",
            "‚ùå WebSocket Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."
          );
          return;
        }

        console.log("‚úÖ Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏãúÏûë");
        addMessage("user", message);
        input.value = "";
        input.style.height = "auto";

        try {
          // ÏõπÏÜåÏºìÏúºÎ°ú Î©îÏãúÏßÄ Ï†ÑÏÜ°
          const messageData = {
            type: "user_message",
            message: message,
          };
          console.log("üì§ Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:", messageData);

          socket.send(JSON.stringify(messageData));
          console.log("‚úÖ Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏôÑÎ£å");

          // Ï†ÑÏÜ° ÌõÑ ÏÜåÏºì ÏÉÅÌÉú Ïû¨ÌôïÏù∏
          setTimeout(() => {
            console.log("üîç Ï†ÑÏÜ° ÌõÑ ÏÜåÏºì ÏÉÅÌÉú:", socket.readyState);
            console.log("üîç Ï†ÑÏÜ° ÌõÑ Ïó∞Í≤∞ ÏÉÅÌÉú:", isConnected);
          }, 100);
        } catch (error) {
          console.error("‚ùå Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:", error);
          addMessage(
            "system",
            "‚ùå Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message
          );
        }
      }

      // ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ°
      function sendExample(message) {
        console.log("üîç sendExample Ìò∏Ï∂úÎê®:", message);
        console.log("üîó Ïó∞Í≤∞ ÏÉÅÌÉú:", isConnected);
        console.log("üåê ÏÜåÏºì ÏÉÅÌÉú:", socket ? socket.readyState : "ÏÜåÏºì ÏóÜÏùå");

        if (!isConnected) {
          console.log("‚ùå Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå - ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° Î∂àÍ∞Ä");
          addMessage(
            "system",
            "‚ùå ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî."
          );
          return;
        }

        if (!socket || socket.readyState !== WebSocket.OPEN) {
          console.log("‚ùå ÏÜåÏºìÏù¥ Ïó¥Î†§ÏûàÏßÄ ÏïäÏùå - ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° Î∂àÍ∞Ä");
          addMessage(
            "system",
            "‚ùå WebSocket Ïó∞Í≤∞Ïù¥ ÎÅäÏñ¥Ï°åÏäµÎãàÎã§. Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî."
          );
          return;
        }

        console.log("‚úÖ ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏãúÏûë");
        addMessage("user", message);

        try {
          const messageData = {
            type: "user_message",
            message: message,
          };
          console.log("üì§ Ï†ÑÏÜ°Ìï† ÏòàÏãú Îç∞Ïù¥ÌÑ∞:", messageData);

          socket.send(JSON.stringify(messageData));
          console.log("‚úÖ ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° ÏôÑÎ£å");
        } catch (error) {
          console.error("‚ùå ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïò§Î•ò:", error);
          addMessage(
            "system",
            "‚ùå ÏòàÏãú Î©îÏãúÏßÄ Ï†ÑÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message
          );
        }
      }

      // Î©îÏãúÏßÄ Ï∂îÍ∞Ä
      function addMessage(type, content, info = "") {
        const messagesContainer = document.getElementById("messages");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${type}`;

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.textContent = content;

        if (info) {
          const infoDiv = document.createElement("div");
          infoDiv.style.fontSize = "11px";
          infoDiv.style.opacity = "0.7";
          infoDiv.style.marginTop = "5px";
          infoDiv.textContent = info;
          contentDiv.appendChild(infoDiv);
        }

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Î¥á Î©îÏãúÏßÄ ÏãúÏûë
      function startBotMessage(initialText = "") {
        const messagesContainer = document.getElementById("messages");

        const messageDiv = document.createElement("div");
        messageDiv.className = "message bot";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";
        contentDiv.textContent = initialText;

        messageDiv.appendChild(contentDiv);
        messagesContainer.appendChild(messageDiv);

        currentBotMessageDiv = contentDiv;
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      // Î¥á Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
      function updateBotMessage(delta) {
        if (!currentBotMessageDiv) {
          startBotMessage();
        }

        currentBotMessageDiv.textContent += delta;
        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      }

      // Î¥á Î©îÏãúÏßÄ ÏôÑÎ£å
      function finalizeBotMessage(finalText) {
        if (currentBotMessageDiv && finalText) {
          currentBotMessageDiv.textContent = finalText;
        }
        currentBotMessageDiv = null;
      }

      // ÏùåÏÑ± Î™®Îìú ÌÜ†Í∏Ä
      function toggleVoiceMode() {
        voiceMode = !voiceMode;
        const btn = document.getElementById("voiceModeBtn");
        const controls = document.getElementById("voiceControls");

        if (voiceMode) {
          btn.textContent = "ÏùåÏÑ± Î™®Îìú ON";
          btn.classList.add("active");
          controls.style.display = "flex";
          initAudioContext();
        } else {
          btn.textContent = "ÏùåÏÑ± Î™®Îìú OFF";
          btn.classList.remove("active");
          controls.style.display = "none";
          if (isRecording) {
            stopRecording();
          }
        }
      }

      // Ïò§ÎîîÏò§ Ïª®ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî
      function initAudioContext() {
        if (!audioContext) {
          audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
        }
      }

      // ÎÖπÏùå ÌÜ†Í∏Ä
      function toggleRecording() {
        if (isRecording) {
          stopRecording();
        } else {
          startRecording();
        }
      }

      // ÎÖπÏùå ÏãúÏûë
      async function startRecording() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: true,
          });
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];

          mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
          };

          mediaRecorder.onstop = () => {
            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            sendAudioToServer(audioBlob);
          };

          mediaRecorder.start();
          isRecording = true;

          const btn = document.getElementById("recordBtn");
          btn.textContent = "üõë ÎÖπÏùå Ï§ëÏßÄ";
          btn.classList.add("recording");

          document.getElementById("recordingStatus").textContent =
            "üé§ ÎÖπÏùå Ï§ë... ÎßêÏîÄÏùÑ ÎßàÏπòÏãúÎ©¥ Ï§ëÏßÄ Î≤ÑÌäºÏùÑ ÎàåÎü¨Ï£ºÏÑ∏Ïöî.";
        } catch (error) {
          console.error("ÎÖπÏùå ÏãúÏûë Ïò§Î•ò:", error);
          addMessage("system", "‚ùå ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
        }
      }

      // ÎÖπÏùå Ï§ëÏßÄ
      function stopRecording() {
        if (mediaRecorder) {
          mediaRecorder.stop();
          mediaRecorder.stream.getTracks().forEach((track) => track.stop());
        }

        isRecording = false;

        const btn = document.getElementById("recordBtn");
        btn.textContent = "üé§ ÎÖπÏùå ÏãúÏûë";
        btn.classList.remove("recording");

        document.getElementById("recordingStatus").textContent =
          "ÏùåÏÑ± Ï≤òÎ¶¨ Ï§ë...";
      }

      // ÏÑúÎ≤ÑÎ°ú Ïò§ÎîîÏò§ Ï†ÑÏÜ° (Ïã§Ï†ú Íµ¨ÌòÑ)
      async function sendAudioToServer(audioBlob) {
        if (!isConnected || !socket || socket.readyState !== WebSocket.OPEN) {
          addMessage("system", "‚ùå ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§.");
          document.getElementById("recordingStatus").textContent =
            "ÏùåÏÑ± Î™®Îìú ÌôúÏÑ±ÌôîÎê®";
          return;
        }

        try {
          console.log("üé§ Ïò§ÎîîÏò§ Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨ ÏãúÏûë:", audioBlob.size, "bytes");
          addMessage("system", "üîÑ ÏùåÏÑ±ÏùÑ ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°ÌïòÍ≥† ÏûàÏäµÎãàÎã§...");

          // AudioBufferÎ°ú Î≥ÄÌôò
          const arrayBuffer = await audioBlob.arrayBuffer();
          const audioContext = new (window.AudioContext ||
            window.webkitAudioContext)();
          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

          // PCM16 ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò
          const pcm16Data = convertToPCM16(audioBuffer);

          // Base64Î°ú Ïù∏ÏΩîÎî©
          const base64Audio = arrayBufferToBase64(pcm16Data);

          // WebSocketÏúºÎ°ú Ï†ÑÏÜ°
          socket.send(
            JSON.stringify({
              type: "audio_data",
              audio: base64Audio,
            })
          );

          // Ïò§ÎîîÏò§ Ï†ÑÏÜ° ÏôÑÎ£å Ïã†Ìò∏
          socket.send(
            JSON.stringify({
              type: "audio_commit",
            })
          );

          console.log("üì° Ïò§ÎîîÏò§ Ï†ÑÏÜ° ÏôÑÎ£å:", base64Audio.length, "characters");

          document.getElementById("recordingStatus").textContent =
            "üîÑ ÏùåÏÑ± ÏùëÎãµÏùÑ Í∏∞Îã§Î¶¨Í≥† ÏûàÏäµÎãàÎã§...";
        } catch (error) {
          console.error("‚ùå Ïò§ÎîîÏò§ Ï†ÑÏÜ° Ïò§Î•ò:", error);
          addMessage(
            "system",
            "‚ùå ÏùåÏÑ± Ï≤òÎ¶¨ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + error.message
          );
          document.getElementById("recordingStatus").textContent =
            "ÏùåÏÑ± Î™®Îìú ÌôúÏÑ±ÌôîÎê®";
        }
      }

      // AudioBufferÎ•º PCM16ÏúºÎ°ú Î≥ÄÌôò
      function convertToPCM16(audioBuffer) {
        const length = audioBuffer.length;
        const pcm16 = new Int16Array(length);
        const channelData = audioBuffer.getChannelData(0); // Ï≤´ Î≤àÏß∏ Ï±ÑÎÑê ÏÇ¨Ïö©

        for (let i = 0; i < length; i++) {
          // Float32Î•º Int16ÏúºÎ°ú Î≥ÄÌôò (-1.0 ~ 1.0 ‚Üí -32768 ~ 32767)
          const sample = Math.max(-1, Math.min(1, channelData[i]));
          pcm16[i] = sample < 0 ? sample * 0x8000 : sample * 0x7fff;
        }

        return pcm16.buffer;
      }

      // ArrayBufferÎ•º Base64Î°ú Î≥ÄÌôò
      function arrayBufferToBase64(buffer) {
        const bytes = new Uint8Array(buffer);
        let binary = "";
        for (let i = 0; i < bytes.byteLength; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return window.btoa(binary);
      }

      // Ïò§ÎîîÏò§ Ïû¨ÏÉù (Ïã§Ï†ú Íµ¨ÌòÑ)
      let audioQueue = [];
      let isPlayingAudio = false;
      let currentAudioContext = null;

      function playAudioDelta(audioData) {
        console.log("üîä Ïò§ÎîîÏò§ Ïû¨ÏÉù:", audioData.length, "characters");

        try {
          // Base64 ÎîîÏΩîÎî©
          const binaryString = window.atob(audioData);
          const bytes = new Uint8Array(binaryString.length);
          for (let i = 0; i < binaryString.length; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }

          // PCM16 Îç∞Ïù¥ÌÑ∞Î•º AudioBufferÎ°ú Î≥ÄÌôò
          const pcm16Data = new Int16Array(bytes.buffer);

          // Ïò§ÎîîÏò§ ÌÅêÏóê Ï∂îÍ∞Ä
          audioQueue.push(pcm16Data);

          // Ïû¨ÏÉù Ï§ëÏù¥ ÏïÑÎãàÎ©¥ Ïû¨ÏÉù ÏãúÏûë
          if (!isPlayingAudio) {
            playNextAudio();
          }
        } catch (error) {
          console.error("‚ùå Ïò§ÎîîÏò§ Ïû¨ÏÉù Ïò§Î•ò:", error);
        }
      }

      async function playNextAudio() {
        if (audioQueue.length === 0) {
          isPlayingAudio = false;
          return;
        }

        isPlayingAudio = true;

        try {
          if (!currentAudioContext) {
            currentAudioContext = new (window.AudioContext ||
              window.webkitAudioContext)();
          }

          const pcm16Data = audioQueue.shift();

          // PCM16Î•º Float32Î°ú Î≥ÄÌôò
          const floatData = new Float32Array(pcm16Data.length);
          for (let i = 0; i < pcm16Data.length; i++) {
            floatData[i] = pcm16Data[i] / 32768.0;
          }

          // AudioBuffer ÏÉùÏÑ± (ÏÉòÌîåÎßÅ Î†àÏù¥Ìä∏ 24000Hz, Î™®ÎÖ∏)
          const audioBuffer = currentAudioContext.createBuffer(
            1,
            floatData.length,
            24000
          );
          audioBuffer.getChannelData(0).set(floatData);

          // AudioSource ÏÉùÏÑ± Î∞è Ïû¨ÏÉù
          const source = currentAudioContext.createBufferSource();
          source.buffer = audioBuffer;
          source.connect(currentAudioContext.destination);

          source.onended = () => {
            // Îã§Ïùå Ïò§ÎîîÏò§ Ïû¨ÏÉù
            setTimeout(() => playNextAudio(), 10);
          };

          source.start();
        } catch (error) {
          console.error("‚ùå Ïò§ÎîîÏò§ Ïû¨ÏÉù Ï≤òÎ¶¨ Ïò§Î•ò:", error);
          isPlayingAudio = false;
        }
      }

      // Ïó∞Í≤∞ ÌÖåÏä§Ìä∏
      function testConnection() {
        if (isConnected && socket && socket.readyState === WebSocket.OPEN) {
          addMessage(
            "system",
            `‚úÖ Ïó∞Í≤∞ ÏÉÅÌÉú ÏñëÌò∏! WebSocketÏù¥ ÏïàÏ†ïÏ†ÅÏúºÎ°ú ÏûëÎèô Ï§ëÏûÖÎãàÎã§.
üìä ÏÉÅÌÉú: ${connectionStable ? "ÏïàÏ†ï" : "Î∂àÏïàÏ†ï"}
üîÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ: ${reconnectAttempts}/${maxReconnectAttempts}
üîó WebSocket ÏÉÅÌÉú: ${socket.readyState === WebSocket.OPEN ? "OPEN" : "CLOSED"}`
          );
        } else if (socket && socket.readyState === WebSocket.CONNECTING) {
          addMessage("system", "üîÑ Ïó∞Í≤∞ ÏãúÎèÑ Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî...");
        } else {
          addMessage(
            "system",
            `‚ùå Ïó∞Í≤∞ÎêòÏßÄ ÏïäÏùå. Îã§ÏùåÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî:
1. npm run dev Î™ÖÎ†πÏúºÎ°ú chatbot.jsÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ
2. Ìè¨Ìä∏ 3000Ïù¥ ÏÇ¨Ïö© Í∞ÄÎä•ÌïúÏßÄ
3. Î∞©ÌôîÎ≤Ω ÏÑ§Ï†ïÏù¥ Ïò¨Î∞îÎ•∏ÏßÄ
üîÑ Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ: ${reconnectAttempts}/${maxReconnectAttempts}`
          );

          // ÏàòÎèô Ïû¨Ïó∞Í≤∞ ÏãúÎèÑ
          if (reconnectAttempts < maxReconnectAttempts) {
            addMessage("system", "üîÑ ÏàòÎèô Ïû¨Ïó∞Í≤∞ÏùÑ ÏãúÎèÑÌï©ÎãàÎã§...");
            setTimeout(() => connectWebSocket(), 1000);
          }
        }
      }

      // ÎåÄÌôî Ï¥àÍ∏∞Ìôî
      function clearChat() {
        const messages = document.getElementById("messages");
        const systemElements = messages.querySelectorAll(
          ".welcome-section, .features, .connection-info, .quick-examples, .controls, .voice-controls"
        );
        messages.innerHTML = "";

        // ÏãúÏä§ÌÖú ÏöîÏÜåÎì§ Îã§Ïãú Ï∂îÍ∞Ä
        systemElements.forEach((el) => messages.appendChild(el));

        addMessage(
          "bot",
          "ÎåÄÌôîÍ∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§. ÏÉàÎ°úÏö¥ ÎåÄÌôîÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî! üîÑ",
          "AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏"
        );
      }

      // Ïó∞Í≤∞ Ï¥àÍ∏∞Ìôî (ÏôÑÏ†Ñ Ïû¨ÏãúÏûë)
      function resetConnection() {
        console.log("Ïó∞Í≤∞ ÏôÑÏ†Ñ Ï¥àÍ∏∞Ìôî ÏãúÏûë...");

        // Î™®Îì† ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }

        // ÏÜåÏºì Ï†ïÎ¶¨
        if (socket) {
          socket.onopen = null;
          socket.onmessage = null;
          socket.onclose = null;
          socket.onerror = null;
          if (
            socket.readyState === WebSocket.OPEN ||
            socket.readyState === WebSocket.CONNECTING
          ) {
            socket.close(1000, "Manual reset");
          }
          socket = null;
        }

        // ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        isConnected = false;
        connectionStable = false;
        reconnectAttempts = 0;

        updateStatus("disconnected", "üîÑ Ï¥àÍ∏∞Ìôî Ï§ë...");
        updateConnectionInfo("Ïó∞Í≤∞ÏùÑ ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÌïòÍ≥† ÏÉàÎ°ú Ïó∞Í≤∞Ìï©ÎãàÎã§...");

        // 1Ï¥à ÌõÑ ÏÉàÎ°ú Ïó∞Í≤∞
        setTimeout(() => {
          connectWebSocket();
        }, 1000);
      }

      // ÏùåÏÑ± Î≥ÄÍ≤Ω
      document
        .getElementById("voiceSelect")
        .addEventListener("change", function () {
          if (isConnected) {
            socket.send(
              JSON.stringify({
                type: "voice_change",
                voice: this.value,
              })
            );
            addMessage("system", `ÏùåÏÑ±Ïù¥ ${this.value}Î°ú Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.`);
          }
        });

      // ÏûÖÎ†•Ï∞Ω ÏûêÎèô ÌÅ¨Í∏∞ Ï°∞Ï†à
      document
        .getElementById("messageInput")
        .addEventListener("input", function () {
          this.style.height = "auto";
          this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });

      // ÏóîÌÑ∞ÌÇ§Î°ú Ï†ÑÏÜ°
      document
        .getElementById("messageInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

      // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Ïó∞Í≤∞ (Ìïú Î≤àÎßå)
      window.addEventListener("load", function () {
        console.log("ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å - Ï¥àÍ∏∞ Ïó∞Í≤∞ ÏãúÏûë");
        // Ï¥àÍ∏∞ ÏÉÅÌÉú ÏÑ§Ï†ï
        reconnectAttempts = 0;
        connectionStable = false;

        // Ï¥àÍ∏∞ Ïó∞Í≤∞ ÏãúÎèÑ
        setTimeout(() => {
          connectWebSocket();
        }, 500); // ÌéòÏù¥ÏßÄ Î°úÎìú ÌõÑ ÏïΩÍ∞Ñ ÏßÄÏó∞
      });

      // ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú Ïãú Ï†ïÎ¶¨
      window.addEventListener("beforeunload", function () {
        console.log("ÌéòÏù¥ÏßÄ Ïñ∏Î°úÎìú - Ïó∞Í≤∞ Ï†ïÎ¶¨");

        // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }

        // ÏÜåÏºì Ï†ïÎ¶¨
        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close(1000, "Page unload");
        }
      });
    </script>
  </body>
</html>
